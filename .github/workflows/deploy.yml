name: Deploy to AWS

on:
  push:
    branches:
      - main
      - develop

jobs:
  deploy-production:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Deploy to Production
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST_PROD }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY_PROD }}
          script: |
            cd configurator
            git fetch origin
            git reset --hard origin/main
            # Create .env file with all backend environment variables
            cat > backend/.env << EOF
            PORT=3001
            MONGODB_URI=${{ secrets.MONGODB_URI_PROD }}
            JWT_SECRET=${{ secrets.JWT_SECRET_PROD }}
            FRONTEND_URL=${{ secrets.FRONTEND_URL_PROD }}
            NODE_ENV=production
            RUN_PARTNER_SCRIPT=${{ secrets.RUN_PARTNER_SCRIPT_PROD }}
            EOF
            # Create frontend .env file if VITE_API_URL is needed
            cat > .env << EOF
            VITE_API_URL=${{ secrets.VITE_API_URL_PROD }}
            EOF
            sudo docker compose --env-file backend/.env up -d --build
            sudo docker image prune -f

  deploy-development:
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Deploy to Development
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST_DEV }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY_DEV }}
          script: |
            cd configurator
            git fetch origin
            git reset --hard origin/develop
            # Create .env file with all backend environment variables
            cat > backend/.env << EOF
            PORT=3001
            MONGODB_URI=${{ secrets.MONGODB_URI_DEV }}
            JWT_SECRET=${{ secrets.JWT_SECRET_DEV }}
            FRONTEND_URL=${{ secrets.FRONTEND_URL_DEV }}
            NODE_ENV=development
            RUN_PARTNER_SCRIPT=${{ secrets.RUN_PARTNER_SCRIPT_DEV }}
            EOF
            # Create frontend .env file if VITE_API_URL is needed
            cat > .env << EOF
            VITE_API_URL=${{ secrets.VITE_API_URL_DEV }}
            EOF
            sudo docker compose --env-file backend/.env up -d --build
            sudo docker image prune -f
